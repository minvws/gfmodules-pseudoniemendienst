name: Release docker container

on:
  push:
    tags:
      - v*

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        name: Build
        runs-on: ubuntu-24.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Run build action
              uses: minvws/action-python-poetry-install@v1
              with:
                python_version: "3.11"


    push_container:
        name: Create and publish Docker image to the Github Package Registry
        runs-on: ubuntu-24.04
        needs: [build]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create version.json
              run: |
                RELEASE_VERSION="${GITHUB_REF#refs/*/}"
                echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
                echo "{ \"version\": \"${RELEASE_VERSION}\", \"git_ref\": \"$GITHUB_SHA\"}" > version.json

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                images: ghcr.io/${{ github.repository }}

            - name: Build Docker image
              uses: docker/build-push-action@v6
              env:
                NEW_UID: 1003
                NEW_GID: 1003
              with:
                context: .
                file: docker/Dockerfile
                push: false
                load: true
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                build-args: |
                  NEW_UID=${{ env.NEW_UID }}
                  NEW_GID=${{ env.NEW_GID }}

#            - name: Run Trivy vulnerability scanner
#              uses: aquasecurity/trivy-action@0.33.1
#              with:
#                image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
#                format: "sarif"
#                output: "trivy-results.sarif"
#                exit-code: "0"
#                severity: "CRITICAL,HIGH"
#                vuln-type: "library"
#
#            - name: Upload Trivy scan results to GitHub Security tab
#              uses: github/codeql-action/upload-sarif@v4
#              # Only upload SARIF results on main branch or version tags
#              if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
#              with:
#                sarif_file: "trivy-results.sarif"
#
#            - name: Fail on vulnerabilities
#              uses: aquasecurity/trivy-action@0.33.1
#              with:
#                image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
#                format: "table"
#                exit-code: "1"
#                severity: "CRITICAL,HIGH"
#                vuln-type: "library"
#                skip-setup-trivy: true

            - name: Push Docker image
              uses: docker/build-push-action@v6
              if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
              env:
                NEW_UID: 1003
                NEW_GID: 1003
              with:
                context: .
                file: docker/Dockerfile
                push: true
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                build-args: |
                  NEW_UID=${{ env.NEW_UID }}
                  NEW_GID=${{ env.NEW_GID }}
